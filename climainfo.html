<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>El Climón - Clima Actual</title>

  <!-- Bootstrap -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />
  <link rel="stylesheet" href="css/article.css" />
</head>
<body>

  <header class="bg-light shadow-sm p-3 d-flex justify-content-between align-items-center">
    <a href="index.html" class="d-flex align-items-center text-decoration-none">
      <img src="src/img/logo.png" class="logo me-2" alt="El Climón" style="height:50px;">
      <span class="fw-bold text-primary">El Climón</span>
    </a>

    <div class="search-bar d-flex">
      <input type="text" id="cityInput" class="form-control me-2" placeholder="Buscar otra Ciudad..." />
      <button id="searchBtn" class="btn btn-primary">Buscar</button>
    </div>

    <nav>
      <a href="nosotros.html" class="me-3 text-secondary">Nosotros</a>
      <a href="#" class="me-3 text-secondary">Usuario</a>
      <a href="index.html" class="fw-semibold text-primary">Inicio</a>
    </nav>
  </header>

  <main class="container my-4">
    <section class="text-center mb-4">
      <h2 id="cityName" class="fw-bold">Ciudad, País</h2>
      <h3 id="temp" class="display-5">--°C</h3>
      <img id="weatherIcon" src="" alt="Icono del clima" style="width:90px;">
      <p id="description" class="lead text-capitalize mt-2"></p>
      <div id="extras" class="text-secondary small"></div>
    </section>

    <section class="forecast">
      <h4 class="mt-5 mb-3 fw-bold">Pronóstico por hora</h4>
      <div class="row" id="hourlyForecast"></div>

      <h4 class="mt-5 mb-3 fw-bold">Pronóstico semanal</h4>
      <div class="row" id="dailyForecast"></div>
    </section>

    <section id="mapResult" class="mt-5"></section>
  </main>

  <footer class="bg-warning-subtle py-3 text-center">
    <p class="mb-2">Todos los derechos reservados</p>
    <div class="social">
      <a href="https://www.facebook.com" target="_blank"><img src="src/img/facebook.png" alt="Facebook" width="24"></a>
      <a href="https://www.linkedin.com" target="_blank"><img src="src/img/linkedin.png" alt="LinkedIn" width="24"></a>
      <a href="https://www.youtube.com" target="_blank"><img src="src/img/YouTube.png" alt="YouTube" width="24"></a>
      <a href="https://www.instagram.com" target="_blank"><img src="src/img/instagram.png" alt="Instagram" width="24"></a>
    </div>
  </footer>

  <script>
    // --- API Key ---
    const apiKey = '579d8622c67f62745e2dc1592a37b897';

    // Helper rápido
    const $ = (sel) => document.querySelector(sel);

    // Buscar desde botón o Enter
    $('#searchBtn').addEventListener('click', getWeather);
    $('#cityInput').addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        getWeather();
      }
    });

    // === Cargar automáticamente si llega desde index.html ===
    window.addEventListener('DOMContentLoaded', () => {
      const params = new URLSearchParams(window.location.search);
      const cityFromURL = params.get('q');
      if (cityFromURL) {
        $('#cityInput').value = cityFromURL;
        getWeather(cityFromURL);
      }
    });

    // === Función principal ===
    async function getWeather(cityParam) {
      const city = cityParam || $('#cityInput').value.trim();
      if (!city) return alert('Por favor, ingresa una ciudad.');

      await getCurrentWeather(city);
      await getForecast(city);
      await getWeatherMap(city);
    }

    // === 1. Clima actual ===
    async function getCurrentWeather(city) {
      const url = `https://api.openweathermap.org/data/2.5/weather?q=${encodeURIComponent(city)}&appid=${apiKey}&units=metric&lang=es`;
      try {
        const res = await fetch(url);
        const data = await res.json();

        if (data.cod === 200) {
          const icon = `https://openweathermap.org/img/wn/${data.weather[0].icon}@2x.png`;
          $('#cityName').textContent = `${data.name}, ${data.sys.country}`;
          $('#temp').textContent = `${Math.round(data.main.temp)}°C`;
          $('#weatherIcon').src = icon;
          $('#description').textContent = data.weather[0].description;
          $('#extras').innerHTML = `
            <div><strong>Sensación:</strong> ${Math.round(data.main.feels_like)}°C</div>
            <div><strong>Humedad:</strong> ${data.main.humidity}%</div>
            <div><strong>Viento:</strong> ${data.wind.speed} m/s</div>
          `;
        } else {
          $('#cityName').textContent = 'No encontrado';
        }
      } catch (err) {
        console.error('Error al obtener clima actual', err);
      }
    }

    // === 2. Pronóstico de 5 días ===
    async function getForecast(city) {
      const url = `https://api.openweathermap.org/data/2.5/forecast?q=${encodeURIComponent(city)}&appid=${apiKey}&units=metric&lang=es`;
      try {
        const res = await fetch(url);
        const data = await res.json();

        if (data.cod === "200") {
          renderHourly(data.list);
          renderDaily(data.list);
        }
      } catch (err) {
        console.error('Error al obtener pronóstico', err);
      }
    }

    function renderHourly(list) {
      const hourly = $('#hourlyForecast');
      hourly.innerHTML = '';
      list.slice(0, 8).forEach(item => {
        const hour = new Date(item.dt * 1000).toLocaleTimeString('es-MX', {hour:'2-digit'});
        const icon = `https://openweathermap.org/img/wn/${item.weather[0].icon}.png`;
        hourly.innerHTML += `
          <div class="col-6 col-md-3 col-lg-2 mb-3 text-center">
            <div class="border rounded p-2">
              <small>${hour}</small>
              <img src="${icon}" alt="">
              <div>${Math.round(item.main.temp)}°C</div>
            </div>
          </div>`;
      });
    }

    function renderDaily(list) {
      const daily = $('#dailyForecast');
      daily.innerHTML = '';
      const grouped = {};

      list.forEach(item => {
        const date = new Date(item.dt * 1000).toLocaleDateString('es-MX', {weekday:'long'});
        if (!grouped[date]) grouped[date] = [];
        grouped[date].push(item);
      });

      Object.entries(grouped).slice(0,5).forEach(([day, values]) => {
        const temps = values.map(v => v.main.temp);
        const avg = Math.round(temps.reduce((a,b)=>a+b)/temps.length);
        const icon = `https://openweathermap.org/img/wn/${values[0].weather[0].icon}.png`;

        daily.innerHTML += `
          <div class="col-6 col-md-3 col-lg-2 mb-3 text-center">
            <div class="border rounded p-2">
              <small class="text-capitalize">${day}</small>
              <img src="${icon}" alt="">
              <div>${avg}°C</div>
            </div>
          </div>`;
      });
    }

    // === 3. Mapa meteorológico ===
    async function getWeatherMap(city) {
      const res = await fetch(`https://api.openweathermap.org/data/2.5/weather?q=${encodeURIComponent(city)}&appid=${apiKey}`);
      const data = await res.json();
      if (data.coord) {
        const { lat, lon } = data.coord;
        $('#mapResult').innerHTML = `
          <h4 class="fw-bold mb-3">Mapa meteorológico</h4>
          <iframe
            src="https://openweathermap.org/weathermap?basemap=map&cities=true&layer=clouds&lat=${lat}&lon=${lon}&zoom=7"
            width="100%" height="400" style="border:0;border-radius:8px"
            allowfullscreen loading="lazy">
          </iframe>`;
      }
    }
  </script>
</body>
</html>
